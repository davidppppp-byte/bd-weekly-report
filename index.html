import React, { useState, useEffect } from 'react';
import { 
  User, Briefcase, TrendingUp, AlertCircle, 
  Target, Copy, FileText, ChevronDown, ChevronUp,
  Plus, Trash2, Download, Users, Mail, CheckCircle, Building2, ClipboardList
} from 'lucide-react';

// Card Component
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

// Section Header Component
const SectionHeader = ({ icon: Icon, title, subtitle, isOpen, toggle }) => (
  <div 
    onClick={toggle}
    className="flex items-center justify-between p-4 bg-stone-50 cursor-pointer hover:bg-stone-100 transition-colors border-b border-stone-100"
  >
    <div className="flex items-center gap-3">
      <div className="p-2 bg-orange-100 rounded-lg text-orange-700">
        <Icon size={20} />
      </div>
      <div>
        <h3 className="font-bold text-stone-800">{title}</h3>
        {subtitle && <p className="text-xs text-stone-500">{subtitle}</p>}
      </div>
    </div>
    {isOpen ? <ChevronUp size={18} className="text-stone-400" /> : <ChevronDown size={18} className="text-stone-400" />}
  </div>
);

export default function BusinessDevWeeklyApp() {
  // --- State ---
  const [activeTab, setActiveTab] = useState('edit'); // 'edit' or 'preview'
  const [sections, setSections] = useState({
    basic: true,
    metrics: true,
    projects: true,
    market: true,
    next: true
  });

  const [formData, setFormData] = useState({
    // 1. Basic Info
    name: '',
    startDate: '',
    endDate: '',
    leaveInfo: '',
    
    // 2. Core Metrics
    metrics: {
      enterprise_dev: { val: 0, note: '' },       // 企業訂單開發 (節慶/大宗採購)
      partnership_dev: { val: 0, note: '' },      // 異業合作開發 (婚戒/月子中心/教會)
      quotes_sent: { val: 0, note: '' },          // 報價單發送 (含官網表單處理)
      orders_signed: { val: 0, note: '' },        // 回簽/下單完成
      deal_amount: { val: 0, note: '' },          // 成交金額
      maintenance_count: { val: 0, note: '' }     // 廠商回暖維護
    },

    // 3. Projects
    projects: [
      { id: 1, name: '', status: '進行中', output: '', blocker: '' }
    ],

    // 4. Market Intel
    market: {
      competitor: '',
      feedback: '',
      challenges: '',
      support: ''
    },

    // 5. Next Week (Updated: Include Admin/Report Tasks)
    nextWeek: {
      enterprise_plan: '',  // 預計企業開發 (節慶/名單)
      partnership_plan: '', // 預計合作通路 (長期)
      maintenance_plan: '', // 預計回暖對象
      admin_plan: '',       // 新增：其他重要任務 (簡報/報告/會議)
      goal_enterprise: 0,   // 量化目標 - 企業
      goal_partner: 0,      // 量化目標 - 合作
      goal_maintenance: 0   // 量化目標 - 回暖
    }
  });

  // Load from local storage on mount
  useEffect(() => {
    const saved = localStorage.getItem('bd_weekly_draft_v4');
    if (saved) {
      try {
        setFormData(JSON.parse(saved));
      } catch (e) {
        console.error("Failed to load draft", e);
      }
    } else {
        // Set default dates
        const today = new Date();
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1);
        const friday = new Date(today);
        friday.setDate(today.getDate() - today.getDay() + 5);
        
        setFormData(prev => ({
            ...prev,
            startDate: monday.toISOString().split('T')[0],
            endDate: friday.toISOString().split('T')[0]
        }));
    }
  }, []);

  // Save to local storage on change
  useEffect(() => {
    localStorage.setItem('bd_weekly_draft_v4', JSON.stringify(formData));
  }, [formData]);

  // --- Handlers ---
  const toggleSection = (key) => {
    setSections(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const handleBasicChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleMetricChange = (key, field, value) => {
    setFormData(prev => ({
      ...prev,
      metrics: {
        ...prev.metrics,
        [key]: { ...prev.metrics[key], [field]: value }
      }
    }));
  };

  const handleProjectChange = (id, field, value) => {
    setFormData(prev => ({
      ...prev,
      projects: prev.projects.map(p => p.id === id ? { ...p, [field]: value } : p)
    }));
  };

  const addProject = () => {
    setFormData(prev => ({
      ...prev,
      projects: [...prev.projects, { id: Date.now(), name: '', status: '進行中', output: '', blocker: '' }]
    }));
  };

  const removeProject = (id) => {
    setFormData(prev => ({
      ...prev,
      projects: prev.projects.filter(p => p.id !== id)
    }));
  };

  const handleMarketChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      market: { ...prev.market, [name]: value }
    }));
  };

  const handleNextWeekChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      nextWeek: { ...prev.nextWeek, [name]: value }
    }));
  };

  const copyToClipboard = () => {
    // Generate simple text format
    let text = `【商務拓展部週誌】${formData.name} (${formData.startDate} ~ ${formData.endDate})\n\n`;
    
    text += `一、工作成果數據\n`;
    text += `• 企業開發：接觸 ${formData.metrics.enterprise_dev.val} 家 (對象: ${formData.metrics.enterprise_dev.note || '無'})\n`;
    text += `• 合作開發：接觸 ${formData.metrics.partnership_dev.val} 家 (對象: ${formData.metrics.partnership_dev.note || '無'})\n`;
    text += `• 報價進度：發出 ${formData.metrics.quotes_sent.val} 份 (含官網需求)\n`;
    text += `• 成交結果：回簽 ${formData.metrics.orders_signed.val} 家 (總額 $${formData.metrics.deal_amount.val})\n`;
    text += `• 關係維護：回暖 ${formData.metrics.maintenance_count.val} 家廠商\n\n`;

    text += `二、重點專案進度\n`;
    formData.projects.forEach(p => {
        if(p.name) text += `• [${p.status}] ${p.name}：${p.output} ${p.blocker ? `(卡關: ${p.blocker})` : ''}\n`;
    });
    text += `\n`;

    text += `三、市場觀察與挑戰\n`;
    text += `• 競品：${formData.market.competitor || '無'}\n`;
    text += `• 客戶聲音：${formData.market.feedback || '無'}\n`;
    text += `• 需支援：${formData.market.support || '無'}\n\n`;

    text += `四、下週計畫\n`;
    text += `• 預計企業開發：${formData.nextWeek.enterprise_plan || '無'}\n`;
    text += `• 預計合作通路：${formData.nextWeek.partnership_plan || '無'}\n`;
    text += `• 預計回暖廠商：${formData.nextWeek.maintenance_plan || '無'}\n`;
    text += `• 其他重要任務：${formData.nextWeek.admin_plan || '無'}\n`;
    text += `• 量化目標：企業 ${formData.nextWeek.goal_enterprise} 家 / 合作 ${formData.nextWeek.goal_partner} 家 / 回暖 ${formData.nextWeek.goal_maintenance} 家`;

    navigator.clipboard.writeText(text).then(() => {
      alert('週誌內容已複製到剪貼簿！');
    });
  };
  
  const printReport = () => {
      window.print();
  }

  // --- Render Helpers ---
  const StatusBadge = ({ status }) => {
    const colors = {
      '未開始': 'bg-stone-100 text-stone-600',
      '進行中': 'bg-blue-100 text-blue-700',
      '已完成': 'bg-green-100 text-green-700',
      '卡關中': 'bg-red-100 text-red-700',
    };
    return <span className={`px-2 py-1 rounded text-xs font-medium ${colors[status]}`}>{status}</span>;
  };

  return (
    <div className="min-h-screen bg-stone-100 font-sans text-stone-800 pb-20 print:bg-white print:pb-0">
      {/* Header */}
      <header className="bg-orange-600 text-white p-4 shadow-md sticky top-0 z-10 print:hidden">
        <div className="max-w-3xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Briefcase size={24} />
            <h1 className="text-xl font-bold tracking-wide">商務拓展部週誌</h1>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setActiveTab('edit')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'edit' ? 'bg-white text-orange-600' : 'text-orange-100 hover:bg-orange-700'}`}
            >
              填寫
            </button>
            <button 
              onClick={() => setActiveTab('preview')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'preview' ? 'bg-white text-orange-600' : 'text-orange-100 hover:bg-orange-700'}`}
            >
              預覽 & 輸出
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-3xl mx-auto p-4 print:p-0 print:max-w-full">
        
        {/* EDIT MODE */}
        {activeTab === 'edit' && (
          <div className="space-y-6">
            
            {/* 1. Basic Info */}
            <Card>
              <SectionHeader 
                icon={User} 
                title="基本資訊" 
                subtitle="填表人、日期與出缺勤"
                isOpen={sections.basic} 
                toggle={() => toggleSection('basic')} 
              />
              {sections.basic && (
                <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-stone-600 mb-1">填表人</label>
                    <input 
                      type="text" 
                      name="name"
                      value={formData.name}
                      onChange={handleBasicChange}
                      className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none" 
                      placeholder="你的名字 (例: MOMO)"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-stone-600 mb-1">休假日/請假</label>
                    <input 
                      type="text" 
                      name="leaveInfo"
                      value={formData.leaveInfo}
                      onChange={handleBasicChange}
                      className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none" 
                      placeholder="例: 12/05 上課"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-stone-600 mb-1">開始日期</label>
                    <input 
                      type="date" 
                      name="startDate"
                      value={formData.startDate}
                      onChange={handleBasicChange}
                      className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none" 
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-stone-600 mb-1">結束日期</label>
                    <input 
                      type="date" 
                      name="endDate"
                      value={formData.endDate}
                      onChange={handleBasicChange}
                      className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none" 
                    />
                  </div>
                </div>
              )}
            </Card>

            {/* 2. Work Metrics */}
            <Card>
              <SectionHeader 
                icon={TrendingUp} 
                title="工作成果數據" 
                subtitle="開發、報價與成交"
                isOpen={sections.metrics} 
                toggle={() => toggleSection('metrics')} 
              />
              {sections.metrics && (
                <div className="p-5 space-y-6">
                  
                  {/* Part A: Development (Hunting) */}
                  <div>
                    <h4 className="text-sm font-bold text-stone-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <Users size={16}/> 主動開發 (Hunting)
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Enterprise Dev */}
                      <div className="bg-stone-50 p-3 rounded-lg border border-stone-100">
                        <label className="flex justify-between text-sm font-medium text-stone-700 mb-1">
                          <span>企業訂單開發 (家)</span>
                        </label>
                        <input 
                          type="number" 
                          value={formData.metrics.enterprise_dev.val}
                          onChange={(e) => handleMetricChange('enterprise_dev', 'val', e.target.value)}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none mb-2"
                        />
                         <input 
                          type="text" 
                          value={formData.metrics.enterprise_dev.note}
                          onChange={(e) => handleMetricChange('enterprise_dev', 'note', e.target.value)}
                          placeholder="對象備註 (例: 中秋/聖誕/補習班)"
                          className="w-full text-xs p-1 bg-transparent border-b border-stone-200 focus:border-orange-400 outline-none text-stone-500"
                        />
                      </div>
                      
                      {/* Partnership Dev */}
                      <div className="bg-stone-50 p-3 rounded-lg border border-stone-100">
                        <label className="flex justify-between text-sm font-medium text-stone-700 mb-1">
                          <span>異業合作開發 (家)</span>
                        </label>
                        <input 
                          type="number" 
                          value={formData.metrics.partnership_dev.val}
                          onChange={(e) => handleMetricChange('partnership_dev', 'val', e.target.value)}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none mb-2"
                        />
                        <input 
                          type="text" 
                          value={formData.metrics.partnership_dev.note}
                          onChange={(e) => handleMetricChange('partnership_dev', 'note', e.target.value)}
                          placeholder="合作對象 (例: 婚宴會館、月子中心)"
                          className="w-full text-xs p-1 bg-transparent border-b border-stone-200 focus:border-orange-400 outline-none text-stone-500"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Part B: Process & Result */}
                  <div>
                    <h4 className="text-sm font-bold text-stone-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <Mail size={16}/> 報價與成交 (Process & Results)
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-stone-50 p-3 rounded-lg border border-stone-100">
                        <label className="text-sm font-medium text-stone-700 mb-1 block">報價單發送 (份)</label>
                        <input 
                          type="number" 
                          value={formData.metrics.quotes_sent.val}
                          onChange={(e) => handleMetricChange('quotes_sent', 'val', e.target.value)}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none mb-2"
                        />
                        <input 
                          type="text" 
                          value={formData.metrics.quotes_sent.note}
                          onChange={(e) => handleMetricChange('quotes_sent', 'note', e.target.value)}
                          placeholder="重點客戶 (含官網需求)"
                          className="w-full text-xs p-1 bg-transparent border-b border-stone-200 focus:border-orange-400 outline-none text-stone-500"
                        />
                      </div>
                      <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                         <div className="flex gap-2 mb-2">
                             <div className="flex-1">
                                <label className="text-sm font-medium text-orange-900 mb-1 block">回簽/下單數 (家)</label>
                                <input 
                                  type="number" 
                                  value={formData.metrics.orders_signed.val}
                                  onChange={(e) => handleMetricChange('orders_signed', 'val', e.target.value)}
                                  className="w-full p-2 border border-orange-200 rounded focus:border-orange-500 outline-none bg-white"
                                />
                             </div>
                             <div className="flex-1">
                                <label className="text-sm font-medium text-orange-900 mb-1 block">總金額 ($)</label>
                                <input 
                                  type="number" 
                                  value={formData.metrics.deal_amount.val}
                                  onChange={(e) => handleMetricChange('deal_amount', 'val', e.target.value)}
                                  className="w-full p-2 border border-orange-200 rounded focus:border-orange-500 outline-none bg-white"
                                />
                             </div>
                         </div>
                         <input 
                          type="text" 
                          value={formData.metrics.orders_signed.note}
                          onChange={(e) => handleMetricChange('orders_signed', 'note', e.target.value)}
                          placeholder="成交備註 (例: 海悅 $160,000)"
                          className="w-full p-2 bg-white border border-orange-200 rounded text-sm focus:border-orange-500 outline-none text-stone-600"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Part C: Maintenance */}
                  <div>
                    <h4 className="text-sm font-bold text-stone-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <CheckCircle size={16}/> 關係維護 (Maintenance)
                    </h4>
                    <div className="bg-stone-50 p-3 rounded-lg border border-stone-100">
                        <label className="text-sm font-medium text-stone-700 mb-1 block">合作廠商/客戶回暖數 (家)</label>
                        <input 
                          type="number" 
                          value={formData.metrics.maintenance_count.val}
                          onChange={(e) => handleMetricChange('maintenance_count', 'val', e.target.value)}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none mb-2"
                        />
                         <input 
                          type="text" 
                          value={formData.metrics.maintenance_count.note}
                          onChange={(e) => handleMetricChange('maintenance_count', 'note', e.target.value)}
                          placeholder="維護對象 (例: 去年的彌月合作月子中心)"
                          className="w-full text-xs p-1 bg-transparent border-b border-stone-200 focus:border-orange-400 outline-none text-stone-500"
                        />
                    </div>
                  </div>
                </div>
              )}
            </Card>

            {/* 3. Projects */}
            <Card>
              <SectionHeader 
                icon={FileText} 
                title="重點專案/任務進度" 
                subtitle="非業績類的行政、優化工作"
                isOpen={sections.projects} 
                toggle={() => toggleSection('projects')} 
              />
              {sections.projects && (
                <div className="p-5">
                  <div className="space-y-4">
                    {formData.projects.map((project, index) => (
                      <div key={project.id} className="p-4 border border-stone-200 rounded-lg bg-stone-50 relative group">
                        <button 
                          onClick={() => removeProject(project.id)}
                          className="absolute top-2 right-2 text-stone-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <Trash2 size={16} />
                        </button>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                          <div className="md:col-span-1">
                             <label className="block text-xs font-bold text-stone-500 mb-1">任務名稱</label>
                             <input 
                              type="text" 
                              value={project.name}
                              onChange={(e) => handleProjectChange(project.id, 'name', e.target.value)}
                              placeholder="例: 競品分析報告"
                              className="w-full p-2 border border-stone-300 rounded text-sm focus:border-orange-500 outline-none"
                            />
                          </div>
                          <div className="md:col-span-1">
                             <label className="block text-xs font-bold text-stone-500 mb-1">狀態</label>
                             <select 
                                value={project.status}
                                onChange={(e) => handleProjectChange(project.id, 'status', e.target.value)}
                                className="w-full p-2 border border-stone-300 rounded text-sm focus:border-orange-500 outline-none bg-white"
                             >
                                <option value="未開始">未開始</option>
                                <option value="進行中">進行中</option>
                                <option value="已完成">已完成</option>
                                <option value="卡關中">卡關中</option>
                             </select>
                          </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                           <div>
                             <label className="block text-xs font-bold text-stone-500 mb-1">本週產出</label>
                             <input 
                              type="text" 
                              value={project.output}
                              onChange={(e) => handleProjectChange(project.id, 'output', e.target.value)}
                              placeholder="例: 完成5家比價"
                              className="w-full p-2 border border-stone-300 rounded text-sm focus:border-orange-500 outline-none"
                            />
                           </div>
                           <div>
                             <label className="block text-xs font-bold text-stone-500 mb-1">卡關/需協助</label>
                             <input 
                              type="text" 
                              value={project.blocker}
                              onChange={(e) => handleProjectChange(project.id, 'blocker', e.target.value)}
                              placeholder="無"
                              className="w-full p-2 border border-stone-300 rounded text-sm focus:border-orange-500 outline-none"
                            />
                           </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <button 
                    onClick={addProject}
                    className="mt-4 flex items-center gap-2 text-sm text-orange-600 font-medium hover:text-orange-700"
                  >
                    <Plus size={16} /> 新增任務
                  </button>
                </div>
              )}
            </Card>

            {/* 4. Market Intel */}
            <Card>
              <SectionHeader 
                icon={AlertCircle} 
                title="市場觀察與挑戰" 
                subtitle="競品動態與客戶真實聲音"
                isOpen={sections.market} 
                toggle={() => toggleSection('market')} 
              />
              {sections.market && (
                <div className="p-5 space-y-4">
                  <div>
                    <label className="block text-sm font-bold text-stone-700 mb-1">
                      本週競品動態 <span className="text-stone-400 font-normal text-xs">(對手推出了什麼新品？價格趨勢？)</span>
                    </label>
                    <textarea 
                      name="competitor"
                      value={formData.market.competitor}
                      onChange={handleMarketChange}
                      className="w-full p-3 border border-stone-300 rounded-lg focus:border-orange-500 outline-none min-h-[80px]"
                      placeholder="例：某某品牌推出了中秋早鳥優惠，打85折..."
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-stone-700 mb-1">
                      客戶反饋/市場聲音 <span className="text-stone-400 font-normal text-xs">(客戶拒絕理由？在意什麼？)</span>
                    </label>
                    <textarea 
                      name="feedback"
                      value={formData.market.feedback}
                      onChange={handleMarketChange}
                      className="w-full p-3 border border-stone-300 rounded-lg focus:border-orange-500 outline-none min-h-[80px]"
                      placeholder="例：客戶希望能分期付款，覺得禮盒包裝不夠大氣..."
                    />
                  </div>
                   <div>
                    <label className="block text-sm font-bold text-stone-700 mb-1">
                      問題與需支援 <span className="text-stone-400 font-normal text-xs">(權限不足或需要主管決策的事項)</span>
                    </label>
                    <textarea 
                      name="support"
                      value={formData.market.support}
                      onChange={handleMarketChange}
                      className="w-full p-3 border border-stone-300 rounded-lg focus:border-orange-500 outline-none min-h-[60px]"
                      placeholder="例：需要確認是否可以針對A客戶給予特殊折扣"
                    />
                  </div>
                </div>
              )}
            </Card>

            {/* 5. Next Week Plan */}
            <Card>
              <SectionHeader 
                icon={Target} 
                title="下週計畫與目標" 
                subtitle="企業/通路開發與維護"
                isOpen={sections.next} 
                toggle={() => toggleSection('next')} 
              />
              {sections.next && (
                <div className="p-5">
                   <div className="space-y-4 mb-4">
                      <div>
                        <h4 className="text-sm font-bold text-stone-600 mb-2 flex items-center gap-1"><Briefcase size={14}/> 預計企業訂單開發 (中秋/聖誕/新春)</h4>
                        <textarea 
                          name="enterprise_plan"
                          value={formData.nextWeek.enterprise_plan}
                          onChange={handleNextWeekChange}
                          placeholder="例：開發 10 間補習班發送聖誕EDM，並致電跟進"
                          className="w-full p-3 border border-stone-300 rounded focus:border-orange-500 outline-none h-20 text-sm"
                        />
                      </div>
                      <div>
                        <h4 className="text-sm font-bold text-stone-600 mb-2 flex items-center gap-1"><Building2 size={14}/> 預計異業通路開發 (婚宴/月子)</h4>
                        <textarea 
                          name="partnership_plan"
                          value={formData.nextWeek.partnership_plan}
                          onChange={handleNextWeekChange}
                          placeholder="例：聯繫 3 間台中市的婚宴會館 (XX會館、OO飯店)"
                          className="w-full p-3 border border-stone-300 rounded focus:border-orange-500 outline-none h-20 text-sm"
                        />
                      </div>
                       <div>
                        <h4 className="text-sm font-bold text-stone-600 mb-2 flex items-center gap-1"><CheckCircle size={14}/> 預計合作廠商回暖</h4>
                        <textarea 
                          name="maintenance_plan"
                          value={formData.nextWeek.maintenance_plan}
                          onChange={handleNextWeekChange}
                          placeholder="例：回訪去年合作過彌月的 2 間月子中心"
                          className="w-full p-3 border border-stone-300 rounded focus:border-orange-500 outline-none h-20 text-sm"
                        />
                      </div>
                      <div>
                        <h4 className="text-sm font-bold text-stone-600 mb-2 flex items-center gap-1"><ClipboardList size={14}/> 其他重要任務 (簡報/報告/會議)</h4>
                        <textarea 
                          name="admin_plan"
                          value={formData.nextWeek.admin_plan}
                          onChange={handleNextWeekChange}
                          placeholder="例：完成Q4業績檢討報告、準備週五主管會議簡報"
                          className="w-full p-3 border border-stone-300 rounded focus:border-orange-500 outline-none h-20 text-sm"
                        />
                      </div>
                   </div>

                   <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-stone-100">
                      <div>
                        <label className="block text-sm font-bold text-stone-700 mb-1">
                          企業開發目標 (家)
                        </label>
                        <input 
                          type="number" 
                          name="goal_enterprise"
                          value={formData.nextWeek.goal_enterprise}
                          onChange={handleNextWeekChange}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-bold text-stone-700 mb-1">
                          通路開發目標 (家)
                        </label>
                        <input 
                          type="number" 
                          name="goal_partner"
                          value={formData.nextWeek.goal_partner}
                          onChange={handleNextWeekChange}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-bold text-stone-700 mb-1">
                          回暖維護目標 (家)
                        </label>
                        <input 
                          type="number" 
                          name="goal_maintenance"
                          value={formData.nextWeek.goal_maintenance}
                          onChange={handleNextWeekChange}
                          className="w-full p-2 border border-stone-300 rounded focus:border-orange-500 outline-none"
                        />
                      </div>
                   </div>
                </div>
              )}
            </Card>

            {/* Hint for preview */}
            <div className="text-center text-stone-500 text-sm pb-10">
              填寫完成後，請點選上方「預覽 & 輸出」查看完整週誌
            </div>

          </div>
        )}

        {/* PREVIEW MODE */}
        {activeTab === 'preview' && (
          <div className="space-y-6 animate-fade-in">
             {/* Report Paper UI */}
             <div className="bg-white shadow-lg p-8 md:p-12 rounded-xl border border-stone-100 print:shadow-none print:border-none print:p-0">
                
                {/* Header */}
                <div className="border-b-2 border-orange-500 pb-4 mb-6 flex justify-between items-end">
                    <div>
                        <h1 className="text-2xl font-bold text-stone-800">商務拓展部｜工作週誌</h1>
                        <p className="text-stone-500 mt-1">填表人：{formData.name || '未填寫'} ｜ 區間：{formData.startDate} ~ {formData.endDate}</p>
                    </div>
                    {formData.leaveInfo && (
                        <div className="text-right">
                            <span className="text-xs bg-stone-100 text-stone-600 px-2 py-1 rounded">
                                休假/請假：{formData.leaveInfo}
                            </span>
                        </div>
                    )}
                </div>

                {/* Section 1: Metrics */}
                <div className="mb-8">
                    <h2 className="text-lg font-bold text-orange-700 mb-3 flex items-center gap-2">
                        <TrendingUp size={20}/> 一、工作成果數據
                    </h2>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div className="p-3 bg-stone-50 rounded border border-stone-100 text-center">
                            <div className="text-xs text-stone-500 mb-1">企業開發</div>
                            <div className="text-xl font-bold text-stone-800">{formData.metrics.enterprise_dev.val} <span className="text-xs font-normal">家</span></div>
                        </div>
                         <div className="p-3 bg-stone-50 rounded border border-stone-100 text-center">
                            <div className="text-xs text-stone-500 mb-1">通路合作</div>
                            <div className="text-xl font-bold text-stone-800">{formData.metrics.partnership_dev.val} <span className="text-xs font-normal">家</span></div>
                        </div>
                         <div className="p-3 bg-stone-50 rounded border border-stone-100 text-center">
                            <div className="text-xs text-stone-500 mb-1">發出報價</div>
                            <div className="text-xl font-bold text-stone-800">{formData.metrics.quotes_sent.val} <span className="text-xs font-normal">份</span></div>
                        </div>
                        <div className="p-3 bg-orange-50 rounded border border-orange-100 text-center">
                            <div className="text-xs text-orange-600 mb-1">回簽下單</div>
                            <div className="text-xl font-bold text-orange-700">{formData.metrics.orders_signed.val} <span className="text-xs font-normal">家</span></div>
                        </div>
                         <div className="p-3 bg-stone-50 rounded border border-stone-100 text-center">
                            <div className="text-xs text-stone-500 mb-1">廠商回暖</div>
                            <div className="text-xl font-bold text-stone-800">{formData.metrics.maintenance_count.val} <span className="text-xs font-normal">家</span></div>
                        </div>
                    </div>
                    {/* Metrics Detail Table */}
                    <table className="w-full text-sm text-left border-collapse">
                        <tbody>
                            <tr className="border-b border-stone-100">
                                <td className="py-2 text-stone-500 font-medium w-24">開發備註</td>
                                <td className="py-2 text-stone-800">
                                  {formData.metrics.enterprise_dev.note && <span className="mr-3 text-stone-600">[企業] {formData.metrics.enterprise_dev.note}</span>}
                                  {formData.metrics.partnership_dev.note && <span className="text-stone-600">[通路] {formData.metrics.partnership_dev.note}</span>}
                                  {!formData.metrics.enterprise_dev.note && !formData.metrics.partnership_dev.note && '-'}
                                </td>
                            </tr>
                            <tr className="border-b border-stone-100">
                                <td className="py-2 text-stone-500 font-medium">成交/報價</td>
                                <td className="py-2 text-stone-800">
                                    {formData.metrics.quotes_sent.note && <span className="mr-2">[報價] {formData.metrics.quotes_sent.note}</span>}
                                    {formData.metrics.orders_signed.note && <span className="text-orange-600 font-medium">[成交] {formData.metrics.orders_signed.note}</span>}
                                    {(!formData.metrics.quotes_sent.note && !formData.metrics.orders_signed.note) && '-'}
                                </td>
                            </tr>
                             <tr className="border-b border-stone-100">
                                <td className="py-2 text-stone-500 font-medium">回暖對象</td>
                                <td className="py-2 text-stone-800">{formData.metrics.maintenance_count.note || '-'}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {/* Section 2: Projects */}
                <div className="mb-8">
                    <h2 className="text-lg font-bold text-orange-700 mb-3 flex items-center gap-2">
                        <FileText size={20}/> 二、重點專案進度
                    </h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-stone-500 uppercase bg-stone-50">
                                <tr>
                                    <th className="px-3 py-2 rounded-l">狀態</th>
                                    <th className="px-3 py-2">專案名稱</th>
                                    <th className="px-3 py-2">本週產出</th>
                                    <th className="px-3 py-2 rounded-r">卡關點</th>
                                </tr>
                            </thead>
                            <tbody>
                                {formData.projects.map(p => (
                                    p.name && (
                                        <tr key={p.id} className="border-b border-stone-50 last:border-0">
                                            <td className="px-3 py-3"><StatusBadge status={p.status} /></td>
                                            <td className="px-3 py-3 font-medium text-stone-800">{p.name}</td>
                                            <td className="px-3 py-3 text-stone-600">{p.output || '-'}</td>
                                            <td className="px-3 py-3 text-red-600">{p.blocker || '-'}</td>
                                        </tr>
                                    )
                                ))}
                                {formData.projects.every(p => !p.name) && (
                                    <tr><td colSpan="4" className="px-3 py-3 text-stone-400 italic">本週無重點專案記錄</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* Section 3: Market & Next Steps (Two Column) */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Market */}
                    <div>
                         <h2 className="text-lg font-bold text-orange-700 mb-3 flex items-center gap-2">
                            <AlertCircle size={20}/> 三、市場觀察
                        </h2>
                        <div className="space-y-4 text-sm text-stone-800">
                            <div>
                                <span className="block font-bold text-stone-600 mb-1">競品動態：</span>
                                <div className="p-3 bg-stone-50 rounded border border-stone-100 min-h-[60px]">
                                    {formData.market.competitor || '無'}
                                </div>
                            </div>
                            <div>
                                <span className="block font-bold text-stone-600 mb-1">客戶反饋：</span>
                                <div className="p-3 bg-stone-50 rounded border border-stone-100 min-h-[60px]">
                                    {formData.market.feedback || '無'}
                                </div>
                            </div>
                            {formData.market.support && (
                                <div>
                                    <span className="block font-bold text-red-600 mb-1">需支援事項：</span>
                                    <div className="p-3 bg-red-50 rounded border border-red-100 text-red-800">
                                        {formData.market.support}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Next Steps */}
                    <div>
                         <h2 className="text-lg font-bold text-orange-700 mb-3 flex items-center gap-2">
                            <Target size={20}/> 四、下週計畫
                        </h2>
                        <div className="bg-stone-50 p-4 rounded-xl border border-stone-100 h-full">
                            <div className="mb-4 space-y-3">
                                <div>
                                    <h5 className="font-bold text-stone-700 mb-1 text-sm pb-1 flex items-center gap-2">
                                        <Briefcase size={12}/> 預計企業訂單開發
                                    </h5>
                                    <div className="text-sm text-stone-800 whitespace-pre-wrap pl-1 border-l-2 border-orange-200">
                                        {formData.nextWeek.enterprise_plan || '無'}
                                    </div>
                                </div>

                                <div>
                                    <h5 className="font-bold text-stone-700 mb-1 text-sm pb-1 flex items-center gap-2">
                                        <Building2 size={12}/> 預計異業通路開發
                                    </h5>
                                    <div className="text-sm text-stone-800 whitespace-pre-wrap pl-1 border-l-2 border-stone-300">
                                        {formData.nextWeek.partnership_plan || '無'}
                                    </div>
                                </div>

                                <div>
                                    <h5 className="font-bold text-stone-700 mb-1 text-sm pb-1 flex items-center gap-2">
                                        <CheckCircle size={12}/> 預計合作廠商回暖
                                    </h5>
                                    <div className="text-sm text-stone-800 whitespace-pre-wrap pl-1 border-l-2 border-stone-300">
                                        {formData.nextWeek.maintenance_plan || '無'}
                                    </div>
                                </div>
                                
                                <div>
                                    <h5 className="font-bold text-stone-700 mb-1 text-sm pb-1 flex items-center gap-2">
                                        <ClipboardList size={12}/> 其他重要任務
                                    </h5>
                                    <div className="text-sm text-stone-800 whitespace-pre-wrap pl-1 border-l-2 border-stone-200">
                                        {formData.nextWeek.admin_plan || '無'}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="grid grid-cols-3 gap-1 text-center text-xs bg-white p-2 rounded border border-stone-100">
                                    <div>企業目標<br/><span className="font-bold text-orange-600 text-sm">{formData.nextWeek.goal_enterprise}</span> 家</div>
                                    <div>通路目標<br/><span className="font-bold text-orange-600 text-sm">{formData.nextWeek.goal_partner}</span> 家</div>
                                    <div>回暖目標<br/><span className="font-bold text-orange-600 text-sm">{formData.nextWeek.goal_maintenance}</span> 家</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 pt-4 border-t border-stone-200 text-center text-xs text-stone-400">
                    蒙恩聽障烘焙坊 - 商務拓展部週誌系統 v3.0
                </div>

             </div>

             {/* Action Buttons */}
             <div className="flex justify-center gap-4 py-8 print:hidden">
                <button 
                    onClick={copyToClipboard}
                    className="flex items-center gap-2 bg-stone-700 text-white px-6 py-3 rounded-xl shadow hover:bg-stone-800 transition-all font-medium"
                >
                    <Copy size={20} /> 複製文字 (Line/Email)
                </button>
                 <button 
                    onClick={printReport}
                    className="flex items-center gap-2 bg-orange-600 text-white px-6 py-3 rounded-xl shadow hover:bg-orange-700 transition-all font-medium"
                >
                    <Download size={20} /> 下載/列印 PDF
                </button>
             </div>
          </div>
        )}

      </main>
    </div>
  );
}